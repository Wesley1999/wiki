# 第1章计算机系统概述（OS）
## 基本概念

### 定义

操作系统（Operating System，OS）是指控制和管理整个计算机系统的硬件与软件资源，合理地组织、调度计算机的工作与资源的分配，进而为其他用户和软件提供方便接口与环境的程序集合。计算机操作系统是随着计算机研究和应用的发展逐步发展形成并发展起来的，它是计算机系统中最基本的系统软件。

### 功能

1. 处理机管理
2. 存储器管理
3. 文件管理
4. 设备管理

### 特征

1. 并发（Concurrence）
2. 共享（Sharing）
3. 虚拟（Virtual）
4. 异步（Asynchronism）

并发和共享是操作系统最基本的两个特征，互为存在条件。没有并发和共享，就谈不上虚拟和异步。

并发是指两个或多个时间在同一时间间隔内发生，并行是在同一时刻发生。

多核CPU同一时刻可以有多个程序并行执行，但并发依然必不可少。

异步性是指，由于资源有限，多个程序以不可预知的速度向前推进。

### 接口

命令接口供用户使用，联机命令接口相当于雇主说一句话工人做一件事，脱机命令接口相当于雇主把要做的事写在清单上，工人逐条完成。

程序接口供程序使用，程序接口由一组系统调用命令组成，用户通过在程序中使用这些系统命令来请求系统为其提供**服务**（不是申请系统资源）。

## 发展与分类

### 手工操作阶段

缺点：人机速度矛盾

### 批处理阶段

#### 单道批处理系统

（引入脱机输入输出技术）

优点：缓解人机速度矛盾

缺点：资源利用率很低

#### 多道批处理系统

（操作系统开始出现）

优点：多道程序并发执行，资源利用率高

缺点：不提供人机交互功能

### 分时操作系统

优点：提供人机交互功能

缺点：不能优先处理紧急任务

### 实时操作系统

硬实时系统：必须在绝对严格的规定时间内完成处理

软实时系统：能接受偶尔违反时间规定

优点：能优先处理紧急任务，及时、可靠

### 网络操作系统

### 分布式操作系统

### 个人计算机操作系统



## 运行环境

### 运行机制

CPU状态分为用户态（目态）和核心态（管态）

CPU处于用户态时，只能执行非特权指令。

CPU处于核心态时，可以执行特权指令



时钟的功能是即使和实现进程的切换。

原语的特点：处于操作系统的最底层，最接近硬件；具有原子性；执行时间短，调用频繁。

### 中断和异常

广义的中断分为内中断和外中断，外中断是狭义的中断。

内中断又称为异常、例外、陷入，信号来自CPU内部，与当前执行的指令有关。

内中断分为自愿中断（指令中断，如访管指令）和强迫中断（硬件中断（缺页）、软件中断（除0））

外中断信号来自CPU外部，与当前执行的指令无关。



内中断的响应不在指令执行结束后，而是再指令执行过程中，因为内中断要立即处理。



中断调用子程序要保存断点（PC）和程序状态寄存器（PSW）的内容，这两者由中断隐指令自动保存，而通用寄存器内容由操作系统保存。

中断处理中，最重要的两个寄存器是PC和PSWR。



中断是操作系统必须提供的功能，计算机中的各种错误都需要中断处理。CPU用户态到核心态的切换也需要中断处理。



中断的处理过程：

1. 每条指令执行结束后，CPU检查是否有外部中断信号
2. 若有外部中断信号，则需要保护被中断进程的CPU环境
3. 根据中断信号类型转入相应的中断处理程序
4. 恢复原进程的CPU环境并退出中断，返回原进程继续往下执行



### 系统调用

系统调用会使CPU中用户态进入核心态。

用户态到核心态是通过**中断**实现的，并且中断是唯一途径。（硬件中断机制 不等于 中断处理程序）

凡是与资源有关的操作（存储分配、进行I/O传输、管理文件等），都必须通过系统调用方式向操作系统提出服务请求，并由操作系统代为完成。

中断发生后，进入中断程序的只能是操作系统程序，因为应用程序不能实现核心态的功能。

**有些**寄存器清零不需要再核心态下运行，例如运算时自己可以操作的寄存器。

广义指令是系统调用命令，必定工作在核心态。

输入输出需要中断操作，在核心态下进行。



## 体系结构

### 大内核

将操作系统的主要功能模块都作为系统内核，运行在核心态。

优点：高性能

缺点：内核代码庞大，结构混乱，难以维护，不稳定

### 微内核

只把最基本的功能保留在内核。

优点：内核功能少，结构清晰，方便维护，稳定可靠

缺点：需要频繁的在核心态与用户态之间切换，性能差

> 大内核与微内核的区别类似CISC和RISC的区别。