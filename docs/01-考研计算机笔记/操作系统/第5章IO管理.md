# 第5章IO管理

## I/O管理概述

### I/O控制方式

| I/O控制方式      | 过程                                                         | 数据流向 | CPU干预频率 | 传送单位 | 优点                                                      | 缺点                                       |
| ---------------- | ------------------------------------------------------------ | -------- | ----------- | -------- | --------------------------------------------------------- | ------------------------------------------ |
| 程序直接控制方式 | CPU发出I/O命令后需要不断轮询                                 | 有CPU    | 极高        | 字       | 简单且易于实现                                            | CPU利用率低                                |
| 中断方式         | 阻塞等待I/O的进程，I/O完成后设备控制器发出中断信号           | 有CPU    | 高          | 字       | CPU利用率高                                               | 一次只能传送一个字，传送大量数据时开销大^1 |
| DMA方式          | I/O完成后DMA控制器发出中断信号，只有传送开始和结束时需要CPU的干预 | 无CPU    | 中          | 块       | 每次读写一个或多个连续的块                                | 不能一次读取多个不连续的块                 |
| 通道控制方式     | 通道会执行通道程序完成I/O，I/O完成后DMA控制器发出中断信号    | 无CPU    | 低          | 一组块   | CPU可以一次指示一系列命令，CPU、通道、I/O设备可以并行工作 | 实现复杂，需要通道硬件的支持               |

^1：CPU在每个指令周期的末尾检查中断，中断需要保存、恢复进程的运行环境，这个过程需要一定的开销，如果中断频率过高，会降低系统性能。



通道就是弱化版的CPU，指令单一，没有自己的内存。

通道程序是放在主存当中的。



通道、设备控制器、设备三者关系层层递进，不能并行工作，控制次序也不能颠倒。

通道控制设备控制器，设备控制器控制设备。

通道控制器与设备控制器之间是一对多的关系，设备控制器与设备之间也是一对多的关系。





DMA控制器的组成：

1. 主机-控制器接口
2. I/O控制逻辑
3. 块设备-控制器接口



中断向量地址是例行程序的入口**地址的地址**。



### I/O子系统的层次结构

1. 用户层I/O软件
2. 设备独立性软件（设备无关软件）
3. 设备驱动程序
4. 中断处理程序
5. 硬件

其中，库函数在1层。

34与硬件交互。

234属于设备管理软件，是操作系统内核部分，即I/O系统，又称I/O核心子系统。

#### I/O设备控制器

I/O设备控制器的组成：

1. CPU与控制器的接口
2. I/O逻辑（用于实现设备控制功能）
3. 控制器与设备的接口



## I/O核心子系统

### 高速缓存与缓冲

缓冲区一般用**内存**实现。（用硬件也可以实现，但是成本高，如TLB）

缓冲区的作用是缓和CPU与I/O设备之间速度不匹配的矛盾。

缓冲区有一个特点：当缓冲区飞控是，不能冲入数据；当缓冲区充满后，才能传输数据。

单缓冲：处理每块数据的用时为max{C, T} + M

双缓冲：处理每块数据的用时为max{C + M, T}

循环缓冲：多个大小相等的缓冲区链接成一个循环队列

缓冲池：有三个缓冲队列：空缓冲队列、装满输入数据的缓冲队列、转满输出数据的缓冲队列



在缓冲机制中，无论是单缓冲、多缓冲还是缓冲池，由于缓冲区是一种临界资源，所以在使用缓冲区时都有一个申请和释放（即互斥）的问题需要考虑

### 设备的分配

设备分配的方式：

1. 独占设备：只允许各个进程串行使用的设备，例如打印机。
2. 共享设备：允许多个进程“同时”使用的设备（在微观上是交替使用的），例如磁盘、扬声器。
3. 虚拟设备：把一个物理设备变换成多个对应的逻辑设备。



设备的分配策略：

静态分配：用于独占设备

动态分配：用于共享设备



设备分配的安全性：

安全分配：进程发出I/O请求后遍进入阻塞态，直到I/O完成后才被唤醒，不会发生死锁，因为破坏了“请求并保持”。

不安全分配：进程在发出I/O请求后继续运行，需要时还可以发出第二个、第三个I/O请求，仅当所请求的设备亦被另一进程占用时才阻塞，可能产生死锁，但可以用银行家算法避免。



设备的分配要考虑固有属性、设备独立性、设备安全性，一般不需要考虑及时性。



设备的独立性：用户在编程时使用的设备与实际设备无关。

### SPOOLing技术（假脱机技术）

脱机输入/输出技术需要专门的外围控制机，SPOOLing技术（假脱机技术）不需要专门地外围机。

SPOOLing技术在**外存（不一定是磁盘）**上开辟输入井和输出井两个存储区域，模拟脱机输入/输出技术。

SPOOLing技术用空间换取时间。

SPOOLing技术将独占设备改造为共享设备，实现了虚拟设备的功能。

SPOOLing技术的主要目的是提高独占设备的利用率。

使用SPOOLing技术，进程不必等I/O操作完成就可以执行输出操作。