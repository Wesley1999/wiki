# 第7章IO系统

## 基本概念

IO指令与普通指令不一样

有通道指令是，I/O指令只需要发出简单的启动、停止信号

I/O设备不可能直接与主板总线相连，它总是通过设备控制器来相连的。

通道程序存放在主存中

通道程序只能由通道执行，不能由CPU执行



## 外部设备

字符显示器所需显示字符的ASCII代码被存放在视频存储器VRAM中。

磁盘的存储时间=平均查询扇区时间+寻道时间+传输时间，其中，平均查询扇区时间为磁盘转半圈所需的时间。

磁盘内圈位密度比外圈大。

磁盘向磁道记录数据只能用串行方式。

RAID0：条带化，提高提高存储速度，无容错能力

RAID1：镜像磁盘阵列，镜像磁盘互为备份

RAID2~5：通过数据校验提高容错能力

RAID技术并不能提高磁盘利用率



## I/O接口

I/O总线分为分为数据线、控制线、地址线。

### I/O接口的功能

1. 实现主机和外设的通信联络控制
2. 进行地址译码和设备选择
3. 实现数据缓冲
4. 信号格式的转换
5. 传送控制命令和状态信息

### I/O接口的基本结构

内部接口与总线相连，本质上是内存、CPU相连，数据的传输方式只能是并行传输。

外部接口通过接口电缆与外设相连，可能是串行页可能是并行。

### I/端口及其编址

I/O端口是指接口电路中可被CPU直接分化发的寄存器。

在执行一条命令时，CPU使用地址总线选择所请求的I/O端口，使用数据总线在CPU寄存器和端口之间传输数据。

统一编址时，直接使用指令系统中的方寸指令来完成输入/输出操作，**访存指令也可以访问I/O设备**

独立编址时，需要使用专门的输入/输出指令来完成输入/输出操作，**访存指令不能访问I/O设备**

统一编址时，用地址码区分存储单元和I/O设备（不是地址线）

独立编址时，用不同的指令区分存储单元和I/O设备



## I/O方式

### 对比

在程序查询方式中，I/O准备、数据传输都是由CPU处理

在程序中断方式中，数据传输由CPU处理

在DMA方式中，只需要一个存储周期

### 程序查询方式

简单低效

外设传来的数据放在CPU寄存器中，所以**一次只能传一个字**。

### 程序中断方式

#### 基本概念

外中断与当前的指令执行无关，所以需要在特定的时间点专门地发出一些查询信号去查询它们的中断请求发出的情况。

串行通信方式传送数据，一定有(1位起始位)和(1位或多位停止位)

CPU响应中断时，通过执行**中断服务程序**（不是中断隐指令）完成通用寄存器的保护。

中断响应的优先级排序：硬件错误->访管->外部中断->程序性->重新启动

#### 工作流程

##### 中断请求

##### 中断判优

总线仲裁方式一般是指I/O设备征用总线的判优方式，而中断判优方式一般是指I/O设备争用CPU的判优方式。

##### CPU响应中断的条件

1. 中断源中由中断请求
2. CPU允许中断及开中断
3. 一条指令执行完毕，且没有更紧急的任务

（CPU不会在指令执行一半的时候去处理中断）

##### 中断隐指令（重要）

（在CPU的指令执行过程中已经学过了）

1. 关中断
2. 保存断点
3. 引出中断服务程序

中断隐指令有硬件直接控制，不在指令系统中。

##### 中断向量

中断向量可以提高中断源的识别速度。

中断向量地址是中断服务程序的入口**地址的地址**

##### 中断处理过程

程序中断过程是由硬件和中断服务程序共同完成的。

1. 关中断
2. 保存断点
3. 引出中断服务程序
4. 保存现场和屏蔽字
5. 开中断
6. 执行中断服务程序
7. 关中断
8. 恢复现场和屏蔽字
9. 开中断、中断返回

其中1~3由硬件完成，其他由中断服务程序完成

#### 多重中断和中断屏蔽技术

CPU要具备多重中断的功能，必须满足下列条件：

1. 在终端付出程序中提前设置开中断指令
2. 优先级别高的中断源有权中断优先级别低的中断源

中断屏蔽技术：1表示屏蔽改中断元的请求，中断源对自己也要屏蔽

### DMA方式

中断请求告知CPU数据传送结束，而不是让CPU控制数据传送

程序中断方式需要保护现场，DMA方式不需要中断现行程序，无需保护现场。

具有DMA接口的设备才能产生DMA请求，没有DMA接口的高速外设不能产生。

DMA方式下数据经过的路径：内存->数据总线->DMAC->外设

#### DMA的传送方式

停止CPU访问主存：简单，未充分发挥CPU对主存的利用率

DMA与CPU交替访存：硬件复杂，效率不高

周期挪用（或周期窃取）：DMA优先，CPU存取周期结束后让出总线





